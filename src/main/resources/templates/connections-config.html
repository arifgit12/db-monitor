<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/main}">
<head>
    <title>Connection Configuration</title>
</head>
<body>
    <!-- Page Title -->
    <th:block layout:fragment="page-title">Database Connections</th:block>

    <!-- Page Subtitle -->
    <th:block layout:fragment="page-subtitle">Configure and manage database connections</th:block>

    <!-- Page Actions -->
    <th:block layout:fragment="page-actions">
        <a href="/connections-config/new" class="btn btn-primary">
            <i class="ti ti-plus"></i> Add New Connection
        </a>
    </th:block>

    <!-- Main Content -->
    <div layout:fragment="content">
        <!-- Success/Error Messages -->
        <div th:if="${success}" class="alert alert-success alert-dismissible" role="alert">
            <div class="d-flex">
                <div><i class="ti ti-check me-2"></i></div>
                <div th:text="${success}"></div>
            </div>
            <a class="btn-close" data-bs-dismiss="alert" aria-label="close"></a>
        </div>
        <div th:if="${error}" class="alert alert-danger alert-dismissible" role="alert">
            <div class="d-flex">
                <div><i class="ti ti-alert-triangle me-2"></i></div>
                <div th:text="${error}"></div>
            </div>
            <a class="btn-close" data-bs-dismiss="alert" aria-label="close"></a>
        </div>

        <!-- Empty State -->
        <div th:if="${#lists.isEmpty(connections)}" class="dashboard-empty-state">
            <div class="dashboard-empty-state-icon">
                <i class="ti ti-database-off"></i>
            </div>
            <h2 class="dashboard-empty-state-title">No database connections configured</h2>
            <p class="dashboard-empty-state-text">
                Add your first database connection to start monitoring
            </p>
            <a href="/connections-config/new" class="btn btn-primary">
                <i class="ti ti-plus"></i> Add Connection
            </a>
        </div>

        <!-- Connections Grid -->
        <div class="row row-cards" th:if="${!#lists.isEmpty(connections)}">
            <div th:each="conn : ${connections}" class="col-md-6 col-lg-4">
                <div class="card"
                     th:classappend="${conn.isDefault ? 'border-success' : ''} + ' ' + ${!conn.isActive ? 'opacity-50' : ''}">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="ti ti-database me-2"></i>
                            <span th:text="${conn.connectionName}">Connection Name</span>
                        </h3>
                        <div class="card-actions">
                            <span th:if="${conn.isDefault}" class="badge bg-success">DEFAULT</span>
                            <span th:if="${!conn.isActive}" class="badge bg-danger">INACTIVE</span>
                            <span th:if="${conn.isActive && !conn.isDefault}" class="badge bg-primary">ACTIVE</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="datagrid">
                            <div class="datagrid-item">
                                <div class="datagrid-title">Type</div>
                                <div class="datagrid-content" th:text="${conn.databaseType}">MySQL</div>
                            </div>
                            <div class="datagrid-item">
                                <div class="datagrid-title">Host</div>
                                <div class="datagrid-content">
                                    <span th:text="${conn.host} + ':' + ${conn.port}">localhost:3306</span>
                                </div>
                            </div>
                            <div class="datagrid-item">
                                <div class="datagrid-title">Database</div>
                                <div class="datagrid-content" th:text="${conn.databaseName}">mydb</div>
                            </div>
                            <div class="datagrid-item">
                                <div class="datagrid-title">Username</div>
                                <div class="datagrid-content" th:text="${conn.username}">root</div>
                            </div>
                            <div class="datagrid-item" th:if="${conn.description}">
                                <div class="datagrid-title">Description</div>
                                <div class="datagrid-content" th:text="${conn.description}">Description</div>
                            </div>
                            <div class="datagrid-item" th:if="${conn.lastTestedAt}">
                                <div class="datagrid-title">Last Tested</div>
                                <div class="datagrid-content">
                                    <span th:text="${#temporals.format(conn.lastTestedAt, 'yyyy-MM-dd HH:mm:ss')}">
                                        2024-01-01 12:00:00
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="d-flex gap-2 flex-wrap">
                            <button class="btn btn-sm btn-success"
                                    th:onclick="'testConnection(' + ${conn.id} + ')'">
                                <i class="ti ti-plug"></i> Test
                            </button>
                            <a th:href="@{'/connections-config/edit/' + ${conn.id}}"
                               class="btn btn-sm btn-warning">
                                <i class="ti ti-edit"></i> Edit
                            </a>
                            <form th:action="@{'/connections-config/toggle-active/' + ${conn.id}}"
                                  method="post" class="d-inline">
                                <button type="submit" class="btn btn-sm btn-primary">
                                    <i class="ti ti-power"></i>
                                    <span th:text="${conn.isActive ? 'Deactivate' : 'Activate'}">Toggle</span>
                                </button>
                            </form>
                            <form th:if="${!conn.isDefault}"
                                  th:action="@{'/connections-config/set-default/' + ${conn.id}}"
                                  method="post" class="d-inline">
                                <button type="submit" class="btn btn-sm btn-success">
                                    <i class="ti ti-star"></i> Set Default
                                </button>
                            </form>
                            <form th:action="@{'/connections-config/delete/' + ${conn.id}}"
                                  method="post"
                                  class="d-inline"
                                  onsubmit="return confirm('Are you sure you want to delete this connection?');">
                                <button type="submit" class="btn btn-sm btn-danger">
                                    <i class="ti ti-trash"></i> Delete
                                </button>
                            </form>
                        </div>
                        <div th:id="'test-result-' + ${conn.id}" class="mt-2" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Page JavaScript -->
    <th:block layout:fragment="extra-js">
        <script>
            function testConnection(id) {
                const resultDiv = document.getElementById('test-result-' + id);
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = '<div class="alert alert-info mb-0"><i class="ti ti-loader me-2"></i>Testing connection...</div>';

                API.post('/connections-config/test/' + id)
                    .then(data => {
                        if (data.success) {
                            resultDiv.innerHTML = '<div class="alert alert-success mb-0"><i class="ti ti-check me-2"></i>' + data.message + '</div>';
                            Toast.success('Connection successful');
                        } else {
                            resultDiv.innerHTML = '<div class="alert alert-danger mb-0"><i class="ti ti-x me-2"></i>' +
                                                  data.message + (data.error ? ': ' + data.error : '') + '</div>';
                            Toast.error('Connection failed');
                        }
                    })
                    .catch(error => {
                        resultDiv.innerHTML = '<div class="alert alert-danger mb-0"><i class="ti ti-x me-2"></i>Error testing connection</div>';
                        Toast.error('Error testing connection');
                    });
            }
        </script>
    </th:block>
</body>
</html>
